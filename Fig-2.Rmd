---
title: "Figure 2 Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
date: "2025-09-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries

```{r load-libraries}
#####getting ready for the circular plot 

library(FNN)
library(data.table) 
library(googlesheets4)
library(vioplot)
library(bitops)
```

## Read Clinical Data

```{r read-clinical}
sheet<- read.csv("/Users/aliamiryousefi/Desktop/GU-material/Prostate SPORE - Sheet1.csv")

high<- subset(sheet$CyCIF.Slide.ID, sheet$Gleason.HighLow=="High")
#removing the ones without any TLS
high<- high[-3]

low<- subset(sheet$CyCIF.Slide.ID, sheet$Gleason.HighLow=="Low")
low<- low[-c(1,4)]
```

## Define Markers and Matrix

```{r define-markers-matrix}
markers<- c("CD3d")
mpflag<- c(2^11)
#marker equabalvazne tof the pflat


mat<- as.data.frame(matrix(0, length(markers), length(names(ldata))))
rownames(mat)<- markers
colnames(mat)<- names(ldata)
```

## Compute Matrix for Stromal TLS

```{r compute-matrix}
#
mat<- list()
for (i in c(1:15, 17:21, 24:29)){
  element_name <- paste(names(ldata)[i])
  Tumor<- subset(ldata[[i]], bitAnd(ldata[[i]]$cflag, 8) == 8)
  Strom<- subset(ldata[[i]], bitAnd(ldata[[i]]$cflag, 8) != 8 & !ldata[[i]]$tcell_dbscan %in% c(-999, 0, -1))
  if (dim(Strom)[1]!=0){
    nStromaTLSs<- length(unique(Strom$tcell_dbscan))
    mat[[element_name]] <- as.data.frame(matrix(0, length(markers), nStromaTLSs))
    rownames(mat[[element_name]])<- markers
    colnames(mat[[element_name]])<- as.character(unique(Strom$tcell_dbscan))
    for (k in 1:nStromaTLSs){
      for (j in 1:length(markers)){
        strom <- subset(Strom, bitAnd(Strom$pflag, mpflag[j]) == mpflag[j] & Strom$tcell_dbscan == unique(Strom$tcell_dbscan)[k])
        data_points <- cbind(Tumor$x, Tumor$y)  # Combine x and y into a matrix
        query_point <- matrix(c(strom$x, strom$y), ncol=2)
        knn_result <- get.knnx(data_points, query_point, k=1)
        nearest_neighbor_index = knn_result$nn.index # Extract the index of the nearest neighbor
        nearest_neighbor <- data_points[nearest_neighbor_index, ]  # Get the coordinates of the nearest neighbor
        diffs <- nearest_neighbor - cbind(strom$x, strom$y)  # Calculate the differences in x and y coordinates between corresponding points
        distances <- sqrt(rowSums(diffs^2)) # Calculate the Euclidean distance for each pair
        mat[[element_name]][j, k] <- mean(distances) # Print the pairwise distances
      }
      print(mat)
    }
    #print(mat)
  }
}
```

## Total Number of TICs

```{r total-tics}
##total number of TICs
sum(unlist(lapply(ldata, function(x) sum(!unique(x$tcell_dbscan) %in% c(-999, 0, -1)))))
```

## T ICA Function

```{r t-ica-function}
T_ica <- function(patientID, tcell_dbscanID){
  d<- ldata[[patientID]]
  df<- subset(d, d$tcell_dbscan==tcell_dbscanID)
  ica_result <- fastICA(as.matrix(df[, c("x", "y")]), n.comp = 2)
  ica_trace<-sum(apply(ica_result$S, 2, var)) # Corrected assignment
  return(round(10000 * (ica_trace - 2), 0))
}
```

## ICA Holder Values for T

```{r ica-holder-t}
###ICA holder values of the T
tD<- list()
for (i in 1:length(names(ldata))){
  if (length(unique(ldata[[i]]$tcell_dbscan)[which(!unique(ldata[[i]]$tcell_dbscan) %in% c(-999, 0, -1))]) != 0){
    tD[[i]] <- unique(ldata[[i]]$tcell_dbscan)[which(!unique(ldata[[i]]$tcell_dbscan) %in% c(-999, 0, -1))]
    c<- numeric(length(tD[[i]]))
    h<- tD[[i]]
    for (j in 1:length(c)){
      c[j] <- T_ica(names(ldata)[i], h[j])
    }
    tD[[i]] <- c
  }
}
```

## Size Holder for T

```{r size-holder-t}
####The size holder of the T

sD<- list()
for (i in 1:length(names(ldata))){
  if (length(unique(ldata[[i]]$tcell_dbscan)[which(!unique(ldata[[i]]$tcell_dbscan) %in% c(-999, 0, -1))]) != 0){
    sD[[i]] <- unique(ldata[[i]]$tcell_dbscan)[which(!unique(ldata[[i]]$tcell_dbscan) %in% c(-999, 0, -1))]
    c<- numeric(length(sD[[i]]))
    h<- sD[[i]]
    for (j in 1:length(c)){
      c[j] <- sum(ldata[[i]]$tcell_dbscan == h[j])
    }
    sD[[i]] <- c
  }
}

names(tD) <- names(ldata)
names(sD) <- names(ldata)

summary(sD)
summary(tD)
```

## Proportion of Ki67+ B Cells

```{r proportion-ki67-b}
####getting the proportion of the Ki67+ B cells


kD<- list()
for (i in 1:length(names(ldata))){
  if (length(unique(ldata[[i]]$tls_id)[which(unique(ldata[[i]]$tls_id) != 0)]) != 0){
    kD[[i]] <- unique(ldata[[i]]$tls_id)[which(unique(ldata[[i]]$tls_id) != 0)]
    c<- numeric(length(kD[[i]]))
    h<- kD[[i]]
    for (j in 1:length(c)){
      c[j] <- sum(ldata[[i]]$tls_id == h[j] & ldata[[i]]$coarse_phen_vec == "B cells" & ldata[[i]]$KiGate == 1)/ sum(ldata[[i]]$tls_id == h[j] & ldata[[i]]$coarse_phen_vec == "B cells")
    }
    kD[[i]] <- c
  }
}

names(tD) <- names(ldata)
names(sD) <- names(ldata)
names(kD) <- names(ldata)
```

## Process Matrix to Mean Distances

```{r process-matrix}
for (i in 1:length(names(mat))){
  for (j in 1:length(colnames(mat[[i]]))){
    colnames(mat[[i]])[j]<- paste(names(mat)[i], colnames(mat[[i]])[j], sep="@")
  }
}

# save(mat, file = "mat.RData")
# 
# load("mat.RData")

matr<- as.data.frame(mat[[1]])
for (i in names(mat)[-1]){
  matr<- cbind(matr, mat[[i]])
}

mean_distances<- colMeans(matr, na.rm = TRUE)*0.325

ld<- log(mean_distances)
ld[which(ld== min(ld))]<- 0
```

## High/Low Definitions

```{r high-low-definitions}
high <- c("LSP12601", "LSP12621", "LSP12625", "LSP12627", "LSP12629", "LSP12635", "LSP12639", "LSP12641", "LSP12649", "LSP12651", "LSP12653", "LSP12655", "LSP12657")
low <- c("LSP12605", "LSP12607", "LSP12611", "LSP12613", "LSP12615", "LSP12617", "LSP12619", "LSP12631", "LSP12633", "LSP12637", "LSP12643", "LSP12645", "LSP12647")
```

## Prepare Data Frame for Regression

```{r prepare-df-regression}
# Define the dataset
df <- data.frame(
  nB = c(26, 0, 1, 3, 0, 13, 8, 1, 7, 9, 1, 0, 20, 1, 33, 2, 9, 6, 3, 4, 8, 2, 7, 2, 22, 15, 6, 11, 37),
  nT = c(0.020405127, 0.003467585, 0.011047806, 0.005371212, 0.006367229, 0.009048946, 0.007304979,
         0.012500612, 0.008962686, 0.014591328, 0.012097804, 0.013707686, 0.009308930, 0.009385821,
         0.004104934, 0.015003471, 0.007240923, 0.020162978, 0.019905578, 0.020782561, 0.013541428,
         0.013791820, 0.005987560, 0.008956455, 0.020483123, 0.006320257, 0.020904223, 0.022965431,
         0.063306298),
  Group = c("High", "Other", "Low", "Low", "Other", "Low", "Low", "Low", "Low", "Low",
            "High", "Other", "High", "High", "High", "Low", "Low", "High", "Low", "High",
            "High", "Low", "Low", "Low", "High", "High", "High", "High", "High")
)

# Filter only High and Low groups
df <- subset(df, Group %in% c("High", "Low"))

# Separate data into High and Low groups
df_high <- subset(df, Group == "High")
df_low <- subset(df, Group == "Low")
```

## Perform Linear Regression

```{r perform-regression}
# Perform linear regression for High and Low groups
fit_high <- lm(nT ~ nB, data = df_high)
fit_low <- lm(nT ~ nB, data = df_low)

# Extract model p-values
p_value_high <- summary(fit_high)$fstatistic
p_value_high <- pf(p_value_high[1], p_value_high[2], p_value_high[3], lower.tail = FALSE)

p_value_low <- summary(fit_low)$fstatistic
p_value_low <- pf(p_value_low[1], p_value_low[2], p_value_low[3], lower.tail = FALSE)
```

## Generate Regression Plot

```{r generate-regression-plot}
# Define colors
colors <- c("High" = "#7570b3", "Low" = "#1b9e77")

# Generate the plot
ggplot(df, aes(x = nB, y = nT, color = Group)) +
  geom_point(size = 3) +  # Scatter plot with color based on High/Low category
  geom_smooth(data = df_high, aes(x = nB, y = nT), method = "lm", color = "#7570b3", se = TRUE) +  # Regression line for High
  geom_smooth(data = df_low, aes(x = nB, y = nT), method = "lm", color = "#1b9e77", se = TRUE) +  # Regression line for Low
  scale_color_manual(values = colors) +  # Assign colors to groups
  theme_minimal() +
  labs(
    x = "nB",
    y = "T prop",
    title = "Regression of T cells proportion vs nB for High and Low Groups"
  ) +
  # Annotate p-values
  annotate("text", x = min(df$nB) + 2, y = max(df$nT) - 0.01,   
           label = paste0("p(Model, High) = ", signif(p_value_high, 3)), color = "#7570b3", hjust = 0) +
  annotate("text", x = min(df$nB) + 2, y = max(df$nT) - 0.02,   
           label = paste0("p(Model, Low) = ", signif(p_value_low, 3)), color = "#1b9e77", hjust = 0) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")  # Center and bold title
  )
```

## Sum of TIC Next to IC Proportion Test

```{r sum-tic-ic-prop-test}
#####sum of the TIC next to IC prop test

PD1m[15,8] <- 33

NBH<- sum(subset(PD1m, PD1m$Group == "High")$nB) -33
NBL<- sum(subset(PD1m, PD1m$Group == "Low")$nB) 

NBTH<- sum(subset(PD1m, PD1m$Group == "High")$nBT) -33
NBTL<- sum(subset(PD1m, PD1m$Group == "Low")$nBT)

#removing the B-infiltrated patient [15]
prop.test(c(NBTH, NBTL), c(NBH, NBL), alternative = "greater")
```

## Proportion Test with Confidence Interval

```{r prop-test-ci}
# Load required libraries
library(ggplot2)
library(Hmisc)  # For Wilson CI calculation

# Perform the proportion test with a confidence interval (95%)
prop_test <- prop.test(c(NBTH, NBTL), c(NBH, NBL), alternative = "greater", conf.level = 0.95)

# Compute proportions
prop_high <- NBTH / NBH
prop_low <- NBTL / NBL

# Compute 90% confidence intervals for each proportion using Wilson Score Interval
ci_high <- binconf(NBTH, NBH, alpha = 0.05, method = "wilson")  # 95% CI for High
ci_low <- binconf(NBTL, NBL, alpha = 0.05, method = "wilson")  # 95% CI for Low

# Create a data frame for visualization
df <- data.frame(
  Group = c("High", "Low"),
  Proportion = c(prop_high, prop_low),
  CI_lower = c(ci_high[2], ci_low[2]),  # Lower bounds of 90% CIs
  CI_upper = c(ci_high[3], ci_low[3]),  # Upper bounds of 90% CIs
  Successes = c(NBTH, NBTL),
  Totals = c(NBH, NBL)
)

# Define colors
colors <- c("High" = "#7570b3", "Low" = "#1b9e77")

# Generate the bar plot
ggplot(df, aes(x = Group, y = Proportion, fill = Group)) +
  geom_bar(stat = "identity", alpha = 0.7, width = 0.5) +  # Bar plot
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2, color = "black") +  # Correct CI error bars
  scale_fill_manual(values = colors) +  # Assign colors to groups
  theme_minimal() +
  labs(
    x = "Group",
    y = "Proportion",
    title = "Proportion Test Between HGG and LGG Groups (95% CI)"
  ) +
  # Annotate successes/total above each bar
  geom_text(aes(label = paste0(Successes, "/", Totals)), vjust = -0.5, size = 5) +
  # Annotate p-value
  annotate("text", x = 1.5, y = max(df$Proportion) + 0.05, 
           label = paste0("p-value = ", signif(prop_test$p.value, 3)), 
           color = ifelse(prop_test$p.value < 0.05, "red", "black"), hjust = 0.5) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")  # Center and bold title
  )
```