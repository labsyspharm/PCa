---
title: "Figure 6 Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
date: "2025-09-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## HLAA Analysis

```{r hlaa-analysis}
####HLAA analysis 

#get the AMACR postive and section them into tumor and none-tumor and check the mean log expression of the HLAA to see if there is a difference in the cohort

markers<- c("Hoechst", "Ki67", "AMCAR", "HMWCK", "CD19", "SMA", "CD20", "CD11b", "CD68", "CD163", "CD4", "CD3d", "CD8a", "TCF1", "FOXP3", "PD1", "CD57", "CD11c", "GranzymeB", "CD15", "HLADR", "CD103", "CD31", "pTBK1", "HLAA", "CD24", "CD44", "CD206")
markers<- markers[length(markers):1]
mpflag<- numeric(length(markers))
for (i in 0:(length(markers)-1)){
  mpflag[i+1]<- 2^i
}
mpflag<- mpflag[length(mpflag):1]

high <- c("LSP12601", "LSP12621", "LSP12625", "LSP12627", "LSP12629", "LSP12635", "LSP12639", "LSP12641", "LSP12649", "LSP12651", "LSP12653", "LSP12655", "LSP12657")
low <- c("LSP12605", "LSP12607", "LSP12611", "LSP12613", "LSP12615", "LSP12617", "LSP12619", "LSP12631", "LSP12633", "LSP12637", "LSP12643", "LSP12645", "LSP12647")


tHLA<- numeric(length(names(ldata)))
sHLA<- numeric(length(names(ldata)))
for(i in 1:length(names(ldata))){
  lsp<- ldata[[i]]
  t<- lsp[which(bitAnd(lsp$pflag, mpflag[26]) == mpflag[26] & bitAnd(lsp$cflag, 8) == 8), "HLAA"]
  s<- lsp[which(bitAnd(lsp$pflag, mpflag[26]) == mpflag[26] & bitAnd(lsp$cflag, 8) != 8), "HLAA"]
  tHLA[i]<- mean(t) / sd(t) 
  sHLA[i]<- mean(s) / sd(s)
}
```

## Assemble and Clean Data Frame

```{r assemble-clean-df}
# 1) assemble & clean
df <- data.frame(
  group = factor(rep(c("tHLA","sHLA"),
                     times = c(length(tHLA), length(sHLA)))),
  value = c(tHLA, sHLA)
)
df <- na.omit(df)
```

## T-Test

```{r t-test}
# 2) t‑test
tt  <- t.test(value ~ group, data = df)
p   <- signif(tt$p.value, 3)
```

## Plot Boxplot

```{r plot-boxplot}
# 3) plot
library(ggplot2)

ggplot(df, aes(x = group, y = value, fill = group)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(width = 0.15, size = 2.5, alpha = 0.5, color = "black") +
  scale_fill_manual(values = c(tHLA = "#4e79a7", sHLA = "#f28e2b")) +
  labs(
    title = paste0("tHLA vs sHLA (t‑test p = ", p, ")"),
    x     = NULL,
    y     = "Value"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

## Tidyverse Plot

```{r tidyverse-plot}
library(tidyverse)
# Define fill and point colours
fill_colors  <- c(tHLA = "#4e79a7", sHLA = "#f28e2b")
point_colors <- c(High = "#7570b3", Low  = "#1b9e77")

# Generate plot
ggplot(df_long, aes(x = Test, y = Value, fill = Test)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  scale_fill_manual(values = fill_colors) +
  geom_jitter(aes(color = group),
              width = 0.1, size = 5, alpha = 0.6) +
  scale_color_manual(values = point_colors) +
  labs(
    title    = paste0("tHLA vs sHLA (paired t-test p = ", pval, ")"),
    subtitle = sprintf("n = %d pairs (%d High, %d Low)",
                       nrow(wide_df),
                       sum(wide_df$group == "High"),
                       sum(wide_df$group == "Low")),
    x        = NULL,
    y        = "Value",
    color    = "Condition",
    fill     = "Test"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "right")
```

## Figure 6 C - Levene Test

```{r figure-6c-levene}
#####


###figure 6 C

# numeric vectors entered from the plot
high <- c(1.05e-3, 1.00e-3, 7.7e-4, 5.5e-4, 3.5e-4,
          2.1e-4, 1.7e-4, 1.4e-4, 7.0e-5, 5.0e-5, 0)

low  <- c(2.4e-4, 1.9e-4, 1.7e-4, 1.5e-4, 1.4e-4,
          1.3e-4, 1.0e-4, 8.0e-5, 0, 0)

# assemble into a data frame for car::leveneTest()
df <- data.frame(
  value = c(high, low),
  group = factor(c(rep("High", length(high)), rep("Low", length(low))))
)

# Levene’s test (median-based, the default in car::leveneTest)
if (!requireNamespace("car", quietly = TRUE)) install.packages("car")
library(car)

leveneTest(value ~ group, data = df)
```

## Extended Figure 6 A - Levene Test

```{r extended-figure-6a-levene}
###extended figure 6 A

## approximate y-values read from the plot  ------------------------------
hgg <- c(0.0033, 0.0028, 0.0018, 0.00150, 0.00130,
         0.00100, 0.00055, 0.00040, 0.00027, 0.00008, 0.00005)

lgg <- c(0.0018, 0.0015, 0.00080, 0.00070, 0.00065, 0.00055,
         0.00048, 0.00040, 0.00023, 0.00018, 0.00010, 0.00006, 0.00002)

dat <- data.frame(
  value = c(hgg, lgg),
  group = factor(c(rep("HGG", length(hgg)), rep("LGG", length(lgg))))
)

## ---------------------------------------------------------------------
## 1.  Homogeneity-of-variance test
## ---------------------------------------------------------------------
if (!requireNamespace("car", quietly = TRUE)) install.packages("car")
library(car)
lev <- leveneTest(value ~ group, data = dat)   # median-based version
print(lev)

## ---------------------------------------------------------------------
## 2.  Location (median) test – Mann-Whitney
## ---------------------------------------------------------------------
wilcox <- wilcox.test(hgg, lgg, exact = FALSE)  # two-sided by default
print(wilcox)
```

## Last Show Case Example

```{r last-show-case}
######last show case example 

csv<- read.csv("Cysift_TLS_output.csv")
csv<- subset(csv, csv$TLS_size > 200)
```

## Plot Contact Group

```{r plot-contact-group}
 ###plot the contact group.
 
 # Re-filter NAs & top 1%
 df0    <- subset(results_df, !is.na(contact_frac))
 cutoff <- quantile(df0$contact_frac, 0.99)
 df     <- subset(df0, contact_frac < cutoff)
 
 # One-sided Wilcoxon
 p_value     <- wilcox.test(contact_frac ~ group, data = df,
                            alternative = "greater", exact = FALSE)$p.value
 overall_frac <- mean(df$contact_frac)
 
 ggplot(df, aes(x = group, y = contact_frac, fill = group)) +
   
   # boxplot without outliers
   geom_boxplot(outlier.shape = NA, width = 0.6) +
   
   # larger, semi-transparent jittered points
   geom_jitter(width = 0.15, shape = 19, size = 2.5, alpha = 0.4, color = "black") +
   
   # your purple/green fills
   scale_fill_manual(values = c(high = "#7570b3", low = "#1b9e77")) +
   
   # raw fraction on y-axis, 3 decimal places
   scale_y_continuous(labels = function(x) sprintf("%.3f", x)) +
   
   labs(
     title    = "CTL Contact Fraction by Group <2um",
     subtitle = sprintf(
       "Avg = %.3f; one-sided Wilcoxon p = %.3f",
       overall_frac, p_value
     ),
     x = NULL,
     y = "Contact Fraction"
   ) +
   
   theme_minimal() +
   theme(
     legend.position  = "none",
     plot.subtitle    = element_text(
       color = if (p_value < 0.05) "red" else "black",
       face  = if (p_value < 0.05) "bold" else "plain"
     ),
     axis.text.x      = element_text(size = 12, face = "bold"),
     axis.text.y      = element_text(size = 10),
     axis.title.y     = element_text(size = 12)
   )
```

## CTL Proportion Plot

```{r ctl-prop-plot}
 ####CTL prop
 
 # Re-filter NAs & top 1%
 df0    <- subset(GranzymeTumor, !is.na(ctl_prop))
 cutoff <- quantile(df0$ctl_prop, 0.99)
 df     <- subset(df0, ctl_prop <= cutoff)
 
 # One-sided Wilcoxon
 p_value     <- wilcox.test(ctl_prop ~ group, data = df,
                            alternative = "greater", exact = FALSE)$p.value
 overall_frac <- mean(df$ctl_prop)
 
 ggplot(df, aes(x = group, y = ctl_prop, fill = group)) +
   
   # boxplot without outliers
   geom_boxplot(outlier.shape = NA, width = 0.6) +
   
   # larger, semi-transparent jittered points
   geom_jitter(width = 0.15, shape = 19, size = 2.5, alpha = 0.4, color = "black") +
   
   # your purple/green fills
   scale_fill_manual(values = c(high = "#7570b3", low = "#1b9e77")) +
   
   # raw fraction on y-axis, 3 decimal places
   scale_y_continuous(labels = function(x) sprintf("%.3f", x)) +
   
   labs(
     title    = "CTL fraction",
     subtitle = sprintf(
       "Avg = %.3f; one-sided Wilcoxon p = %.3f",
       overall_frac, p_value
     ),
     x = NULL,
     y = "CTL Fraction"
   ) +
   
   theme_minimal() +
   theme(
     legend.position  = "none",
     plot.subtitle    = element_text(
       color = if (p_value < 0.05) "red" else "black",
       face  = if (p_value < 0.05) "bold" else "plain"
     ),
     axis.text.x      = element_text(size = 12, face = "bold"),
     axis.text.y      = element_text(size = 10),
     axis.title.y     = element_text(size = 12)
   )
```

## Distance Median Plot

```{r dist-med-plot}
 ##dist_med
 
 # Re-filter NAs & top 1%
 df0    <- subset(GranzymeTumor, !is.na(dist_med))
 cutoff <- quantile(df0$dist_med, 0.99)
 df     <- subset(df0, dist_med <= cutoff)
 
 # One-sided Wilcoxon
 p_value     <- wilcox.test(dist_med ~ group, data = df,
                            alternative = "greater", exact = FALSE)$p.value
 overall_frac <- mean(df$dist_med)
 
 ggplot(df, aes(x = group, y = dist_med, fill = group)) +
   
   # boxplot without outliers
   geom_boxplot(outlier.shape = NA, width = 0.6) +
   
   # larger, semi-transparent jittered points
   geom_jitter(width = 0.15, shape = 19, size = 2.5, alpha = 0.4, color = "black") +
   
   # your purple/green fills
   scale_fill_manual(values = c(high = "#7570b3", low = "#1b9e77")) +
   
   # raw fraction on y-axis, 3 decimal places
   scale_y_continuous(labels = function(x) sprintf("%.3f", x)) +
   
   labs(
     title    = "Median distance of CTLs to tumor",
     subtitle = sprintf(
       "Avg = %.3f; one-sided Wilcoxon p = %.3f",
       overall_frac, p_value
     ),
     x = NULL,
     y = "log(micron)"
   ) +
   
   theme_minimal() +
   theme(
     legend.position  = "none",
     plot.subtitle    = element_text(
       color = if (p_value < 0.05) "red" else "black",
       face  = if (p_value < 0.05) "bold" else "plain"
     ),
     axis.text.x      = element_text(size = 12, face = "bold"),
     axis.text.y      = element_text(size = 10),
     axis.title.y     = element_text(size = 12)
   )
```

## Tumor Density Plot

```{r tumor-density-plot}
###3rd quantile of the density of tumor cells around CTL

# Re-filter NAs & top 1%
df0    <- subset(GranzymeTumor, !is.na( dens_q3))
cutoff <- quantile(df0$ dens_q3, 0.99)
df     <- subset(df0,  dens_q3 <= cutoff)

# One-sided Wilcoxon
p_value     <- wilcox.test( dens_q3 ~ group, data = df,
                            alternative = "greater", exact = FALSE)$p.value
overall_frac <- mean(df$ dens_q3)

ggplot(df, aes(x = group, y =  dens_q3, fill = group)) +
  
  # boxplot without outliers
  geom_boxplot(outlier.shape = NA, width = 0.6) +
  
  # larger, semi-transparent jittered points
  geom_jitter(width = 0.15, shape = 19, size = 2.5, alpha = 0.4, color = "black") +
  
  # your purple/green fills
  scale_fill_manual(values = c(high = "#7570b3", low = "#1b9e77")) +
  
  # raw fraction on y-axis, 3 decimal places
  scale_y_continuous(labels = function(x) sprintf("%.3f", x)) +
  
  labs(
    title    = "3rd quantile of the tumor density around calculated on 50 micron radius of CLT",
    subtitle = sprintf(
      "Avg = %.3f; one-sided Wilcoxon p = %.3f",
      overall_frac, p_value
    ),
    x = NULL,
    y = "tumor density (cells/micron-squared)"
  ) +
  
  theme_minimal() +
  theme(
    legend.position  = "none",
    plot.subtitle    = element_text(
      color = if (p_value < 0.05) "red" else "black",
      face  = if (p_value < 0.05) "bold" else "plain"
    ),
    axis.text.x      = element_text(size = 12, face = "bold"),
    axis.text.y      = element_text(size = 10),
    axis.title.y     = element_text(size = 12)
  )
```

## Proportion 20 Micron Plot

```{r prop-20-plot}
###prop 20 micron

# Re-filter NAs & top 1%
df0    <- subset(GranzymeTumor, !is.na(prop_20))
cutoff <- quantile(df0$ prop_20, 0.99)
df     <- subset(df0,  prop_20 <= cutoff)

# One-sided Wilcoxon
p_value     <- wilcox.test( prop_20 ~ group, data = df,
                            alternative = "greater", exact = FALSE)$p.value
overall_frac <- mean(df$prop_20)

ggplot(df, aes(x = group, y = prop_20, fill = group)) +
  
  # boxplot without outliers
  geom_boxplot(outlier.shape = NA, width = 0.6) +
  
  # larger, semi-transparent jittered points
  geom_jitter(width = 0.15, shape = 19, size = 2.5, alpha = 0.4, color = "black") +
  
  # your purple/green fills
  scale_fill_manual(values = c(high = "#7570b3", low = "#1b9e77")) +
  
  # raw fraction on y-axis, 3 decimal places
  scale_y_continuous(labels = function(x) sprintf("%.3f", x)) +
  
  labs(
    title    = "Fraction of CTLs within 20 micron radius of tumor",
    subtitle = sprintf(
      "Avg = %.3f; one-sided Wilcoxon p = %.3f",
      overall_frac, p_value
    ),
    x = NULL,
    y = "Fraction of CTLs"
  ) +
  
  theme_minimal() +
  theme(
    legend.position  = "none",
    plot.subtitle    = element_text(
      color = if (p_value < 0.05) "red" else "black",
      face  = if (p_value < 0.05) "bold" else "plain"
    ),
    axis.text.x      = element_text(size = 12, face = "bold"),
    axis.text.y      = element_text(size = 10),
    axis.title.y     = element_text(size = 12)
  )
```

## Kcross Plot

```{r kcross-plot}
###Kcross


# Re-filter NAs & top 1%
df0    <- subset(GranzymeTumor, !is.na(kcross_avg))
cutoff <- quantile(df0$kcross_avg, 0.99)
df     <- subset(df0,  kcross_avg <= cutoff)

# One-sided Wilcoxon
p_value     <- wilcox.test(kcross_avg ~ group, data = df,
                           alternative = "greater", exact = FALSE)$p.value
overall_frac <- mean(df$kcross_avg)

ggplot(df, aes(x = group, y = kcross_avg, fill = group)) +
  
  # boxplot without outliers
  geom_boxplot(outlier.shape = NA, width = 0.6) +
  
  # larger, semi-transparent jittered points
  geom_jitter(width = 0.15, shape = 19, size = 2.5, alpha = 0.4, color = "black") +
  
  # your purple/green fills
  scale_fill_manual(values = c(high = "#7570b3", low = "#1b9e77")) +
  
  # raw fraction on y-axis, 3 decimal places
  scale_y_continuous(labels = function(x) sprintf("%.3f", x)) +
  
  labs(
    title    = "XX",
    subtitle = sprintf(
      "Avg = %.3f; one-sided Wilcoxon p = %.3f",
      overall_frac, p_value
    ),
    x = NULL,
    y = "XX"
  ) +
  
  theme_minimal() +
  theme(
    legend.position  = "none",
    plot.subtitle    = element_text(
      color = if (p_value < 0.05) "red" else "black",
      face  = if (p_value < 0.05) "bold" else "plain"
    ),
    axis.text.x      = element_text(size = 12, face = "bold"),
    axis.text.y      = element_text(size = 10),
    axis.title.y     = element_text(size = 12)
  )
```